<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WebSocket Chat</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #chat { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; background: #f9f9f9; }
    .message { margin: 5px 0; padding: 5px; border-radius: 5px; background: #e1eaff; }
    .own-message { background: #d4f5d4; text-align: right; }
    #onlineUsers { margin-top: 10px; font-size: 0.9em; color: #555; }
    input[type="text"] { width: 70%; padding: 5px; }
    button { padding: 5px 10px; }
  </style>
</head>
<body>
  <h2>üî• WebSocket Chat</h2>

  <div>
    <label>Room ID:
      <input id="roomId" type="number" value="1" min="1"/>
    </label>
    <button onclick="connect()">Connect</button>
  </div>

  <div id="chat"></div>
  <input id="messageInput" type="text" placeholder="Type your message..." />
  <button onclick="sendMessage()">Send</button>
  <div id="onlineUsers">üë• Online: (–Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ)</div>

  <script>
    let socket;
    let currentUsername = null;
    const roomIdInput = document.getElementById("roomId");
    const messageInput = document.getElementById("messageInput");
    const chatDiv = document.getElementById("chat");
    const onlineUsersDiv = document.getElementById("onlineUsers");

    async function connect() {
      if (socket) {
        socket.close();
      }

      const roomId = roomIdInput.value;

      try {
        const response = await fetch("http://localhost:8000/auth/me", {
          method: "GET",
          credentials: "include", // <-- –≤–æ—Ç —Ç—É—Ç –±—Ä–∞—É–∑–µ—Ä –æ—Ç–ø—Ä–∞–≤–∏—Ç cookie
        });

        if (!response.ok) {
          alert("‚ùå Not authenticated. Please log in first.");
          return;
        }

        const data = await response.json();
        currentUsername = data.username;

        socket = new WebSocket(`ws://localhost:8000/ws/${roomId}`);

        socket.onopen = () => {
          console.log("‚úÖ WebSocket connected");
          chatDiv.innerHTML = ""; // <-- –≤–æ—Ç –∑–¥–µ—Å—å —á–∏—Å—Ç–∏–º —á–∞—Ç
          chatDiv.innerHTML += `<div class="message">üì° Connected to room ${roomId}</div>`;
        };


        socket.onmessage = event => {
          try {
            const data = JSON.parse(event.data);

            if (data.type === "users_online") {
              onlineUsersDiv.textContent = `üë• Online: ${data.users.length ? data.users.join(', ') : "(–Ω–∏–∫–æ–≥–æ –Ω–µ—Ç üò¢)"}`;
              return;
            }

            if (data.type === "system") {
              const sysMsg = document.createElement("div");
              sysMsg.classList.add("message");
              sysMsg.style.fontStyle = "italic";
              sysMsg.style.color = "#999";
              sysMsg.textContent = data.content;
              chatDiv.appendChild(sysMsg);
              chatDiv.scrollTop = chatDiv.scrollHeight;
              return;
            }

            const messageEl = document.createElement("div");
            messageEl.classList.add("message");
            if (data.username === currentUsername) {
              messageEl.classList.add("own-message");
            }

            messageEl.textContent = `${data.username}: ${data.content}`;
            chatDiv.appendChild(messageEl);
            chatDiv.scrollTop = chatDiv.scrollHeight;
          } catch (err) {
            console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:", err);
          }
        };

        socket.onclose = () => {
          console.log("‚ùå Disconnected");
          chatDiv.innerHTML += `<div class="message">‚ùå Disconnected</div>`;
        };
      } catch (err) {
        alert("‚ö† –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: " + err.message);
      }
    }

    function sendMessage() {
      if (!socket || socket.readyState !== WebSocket.OPEN) {
        alert("WebSocket not connected!");
        return;
      }
      const text = messageInput.value;
      if (!text) return;

      socket.send(text);
      messageInput.value = "";
    }

    messageInput.addEventListener("keyup", function (event) {
      if (event.key === "Enter") {
        sendMessage();
      }
    });

    window.onload = connect;
  </script>
</body>
</html>
