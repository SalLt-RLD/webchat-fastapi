<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebSocket Chat Test</title>
</head>
<body>
<h2>üî• WebSocket Chat</h2>

<label>Room ID:
    <input id="roomId" type="number" value="3" />
</label><br><br>

<label>Message:
    <input id="messageInput" type="text" />
</label>

<button onclick="sendMessage()">Send</button>

<ul id="messagesList"></ul>

<script>
    let socket;

    const roomIdInput = document.getElementById("roomId");
    const messageInput = document.getElementById("messageInput");
    const messagesList = document.getElementById("messagesList");

    function connect() {
        const roomId = roomIdInput.value;
        const token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIyIiwiZXhwIjoxNzUyOTYyNTg0fQ.L6XrkYUf-vBZr0Z-m1MgKI0pX5qAE2g3RPYs4P3NrGs"
        socket = new WebSocket(`ws://localhost:8000/ws/${roomId}?token=` + token);
<!--        socket = new WebSocket(`ws://localhost:8000/ws/${roomId}`);-->

        socket.onopen = () => {
            console.log("‚úÖ WebSocket connected");
        };

        socket.onmessage = event => {
            try {
                const message = JSON.parse(event.data);  // –ü–∞—Ä—Å–∏–º —Å—Ç—Ä–æ–∫—É JSON –≤ –æ–±—ä–µ–∫—Ç
                const li = document.createElement("li");
                li.innerText = `${message.user_id}: ${message.content}`;
                messagesList.appendChild(li);
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:", err);
                // –ï—Å–ª–∏ –ø—Ä–∏—à–ª–æ –Ω–µ JSON, –≤—ã–≤–æ–¥–∏–º –∫–∞–∫ –µ—Å—Ç—å (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
                const li = document.createElement("li");
                li.innerText = event.data;
                messagesList.appendChild(li);
            }
        };
        socket.onclose = () => {
            console.log("‚ùå WebSocket disconnected");
        };

        socket.onerror = err => {
            console.error("WebSocket error:", err);
        };
    }

    function sendMessage() {
        if (!socket || socket.readyState !== WebSocket.OPEN) {
            connect(); // –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è, –µ—Å–ª–∏ –µ—â–µ –Ω–µ—Ç
            setTimeout(() => sendMessage(), 500); // –ø–æ–¥–æ–∂–¥—ë–º –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
            return;
        }
        const message = messageInput.value;
        socket.send(message);
        messageInput.value = "";
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.onload = connect;
</script>
</body>
</html>
